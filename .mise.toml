# ============================================================================
# Talos Cluster Automation with mise
# ============================================================================
# This file provides task automation for managing a Talos Linux Kubernetes
# cluster with 3 control plane nodes.
#
# Quick Start (New Cluster):
#   1. mise run gen-cluster     # Generate secrets + configs
#   2. mise run init            # Initialize cluster
#   3. mise run health          # Verify health
#
# Update Existing Cluster:
#   1. mise run update          # Regenerate configs (keeps secrets)
#   2. mise run apply           # Apply to all nodes
#   3. mise run health          # Verify health
# ============================================================================

# === Environment Variables ===

[env]
URD_IP = "192.168.0.120"
VERDANDI_IP = "192.168.0.121"
SKULD_IP = "192.168.0.122"
CONTROL_PLANE_ENDPOINT = "https://192.168.0.120:6443"

# ============================================================================
# PHASE 1: Image & Extension Management
# ============================================================================
# These tasks help you create custom Talos images with system extensions
# via the Talos Image Factory.

[tasks.generate-schematic]
description = "Generate schematic ID from extensions.yaml"
run = """
echo "==> Generating schematic from extensions.yaml..."
SCHEMATIC_ID=$(curl -X POST --data-binary @src/talos/extensions.yaml https://factory.talos.dev/schematics)

echo ""
echo "âœ“ Schematic ID: $SCHEMATIC_ID"
echo ""
echo "==> Download URLs:"
echo "SecureBoot ISO:"
echo "  https://factory.talos.dev/image/$SCHEMATIC_ID/v1.11.5/metal-amd64-secureboot.iso"
echo ""
echo "Installer image for image.yaml:"
echo "  factory.talos.dev/installer-secureboot/$SCHEMATIC_ID:v1.11.5"
echo ""
echo "âš ï¸  Next steps:"
echo "1. Download the SecureBoot ISO from the URL above"
echo "2. Update src/talos/patches/image.yaml with the installer path"
echo "3. Run 'mise run update' to regenerate configs with new image"
"""

# ============================================================================
# PHASE 2: Configuration Generation (New Cluster)
# ============================================================================
# These tasks generate the initial cluster configuration files.
# Only run these when setting up a NEW cluster.

[tasks.gen-secrets]
description = "Generate Talos secrets (NEW CLUSTER ONLY)"
run = """
if [ -f secrets.yaml ]; then
  echo "âŒ secrets.yaml already exists!"
  echo ""
  echo "This file contains cluster CA certificates and keys."
  echo "Regenerating it will DESTROY your existing cluster."
  echo ""
  echo "To force regeneration, delete secrets.yaml first."
  exit 1
fi
echo "==> Generating cluster secrets..."
talosctl gen secrets -o secrets.yaml
echo "âœ“ secrets.yaml created"
"""

[tasks.gen-config]
description = "Generate Talos machine configs from secrets and patches"
run = """
if [ ! -f secrets.yaml ]; then
  echo "âŒ secrets.yaml not found!"
  echo "Run 'mise run gen-secrets' first to create secrets for a new cluster."
  exit 1
fi

echo "==> Generating base machine configs..."
talosctl gen config \
  --with-secrets secrets.yaml \
  --config-patch-control-plane @src/talos/patches/scheduling.yaml \
  --config-patch @src/talos/patches/image.yaml \
  --config-patch @src/talos/patches/kubelet.yaml \
  norns ${CONTROL_PLANE_ENDPOINT} --force

echo "==> Patching node-specific configs (hostnames)..."
talosctl machineconfig patch controlplane.yaml \
  --patch @src/talos/patches/network-urd.yaml \
  --output controlplane-urd.yaml

talosctl machineconfig patch controlplane.yaml \
  --patch @src/talos/patches/network-verdandi.yaml \
  --output controlplane-verdandi.yaml

talosctl machineconfig patch controlplane.yaml \
  --patch @src/talos/patches/network-skuld.yaml \
  --output controlplane-skuld.yaml

echo ""
echo "âœ“ Configuration files generated:"
echo "  - controlplane.yaml (base config)"
echo "  - controlplane-urd.yaml"
echo "  - controlplane-verdandi.yaml"
echo "  - controlplane-skuld.yaml"
echo "  - talosconfig (CLI config)"
"""

[tasks.gen-cluster]
description = "Generate complete cluster config (NEW CLUSTER ONLY)"
alias = "gc"
depends = ["gen-secrets", "gen-config"]

# ============================================================================
# PHASE 3: Configuration Updates (Existing Cluster)
# ============================================================================
# These tasks regenerate configs while preserving secrets.
# Use these when modifying patches or updating images.

[tasks.update]
description = "Regenerate configs after changing patches (preserves secrets)"
depends = ["gen-config"]

[tasks.setup-networking]
description = "Complete networking setup (Gateway API + Cilium + enable as default CNI)"
run = """
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              Setting Up Cluster Networking                     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "==> [1/5] Installing Gateway API CRDs..."
kubectl apply -f src/bootstrap/gateway-api/crds.yaml
echo "âœ“ Gateway API CRDs installed"
echo ""

echo "==> [2/5] Installing Cilium with Hubble and Gateway API support..."
helm upgrade --install cilium cilium/cilium --version 1.18.3 \
  --namespace kube-system \
  --values src/bootstrap/cilium/values.yaml
echo "âœ“ Cilium installed"
echo ""

echo "==> [3/5] Waiting for Cilium to be ready..."
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=cilium-agent -n kube-system --timeout=180s
echo "âœ“ Cilium is ready"
echo ""

echo "==> [4/5] Regenerating Talos configs to disable default CNI and kube-proxy..."
talosctl gen config \
  --with-secrets secrets.yaml \
  --config-patch-control-plane @src/talos/patches/scheduling.yaml \
  --config-patch @src/talos/patches/image.yaml \
  --config-patch @src/talos/patches/kubelet.yaml \
  --config-patch @src/talos/patches/cilium.yaml \
  norns ${CONTROL_PLANE_ENDPOINT} --force

talosctl machineconfig patch controlplane.yaml \
  --patch @src/talos/patches/network-urd.yaml \
  --output controlplane-urd.yaml

talosctl machineconfig patch controlplane.yaml \
  --patch @src/talos/patches/network-verdandi.yaml \
  --output controlplane-verdandi.yaml

talosctl machineconfig patch controlplane.yaml \
  --patch @src/talos/patches/network-skuld.yaml \
  --output controlplane-skuld.yaml

echo "âœ“ Configs regenerated with Cilium enabled"
echo ""

echo "==> Applying configs to all nodes..."
talosctl apply-config --nodes ${URD_IP} --file controlplane-urd.yaml
talosctl apply-config --nodes ${VERDANDI_IP} --file controlplane-verdandi.yaml
talosctl apply-config --nodes ${SKULD_IP} --file controlplane-skuld.yaml
echo "âœ“ Configs applied"
echo ""

echo "==> Rebooting all nodes to apply changes..."
talosctl reboot --nodes ${SKULD_IP} --wait
echo "  âœ“ skuld rebooted"
talosctl reboot --nodes ${VERDANDI_IP} --wait
echo "  âœ“ verdandi rebooted"
talosctl reboot --nodes ${URD_IP} --wait
echo "  âœ“ urd rebooted"
echo ""

echo "==> [5/5] Verifying kube-proxy is gone..."
sleep 10
kubectl get pods -n kube-system | grep kube-proxy && echo "âŒ kube-proxy still running!" || echo "âœ“ kube-proxy removed"
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          Networking Setup Complete! ğŸ‰                         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "âœ“ Gateway API CRDs installed"
echo "âœ“ Cilium with Hubble, Gateway API, and L2 announcements installed"
echo "âœ“ Cilium is now the sole CNI (Flannel and kube-proxy removed)"
echo ""
echo "Next steps:"
echo "  - Run 'mise run health' to verify cluster health"
echo "  - (Optional) Run 'mise run bootstrap-gitops' to install ArgoCD"
"""

[tasks.setup-loadbalancer]
description = "Configure Cilium L2 announcements for LoadBalancer IPs (192.168.0.200-253)"
run = """
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘        Configuring LoadBalancer IP Pool (Cilium L2)           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "==> Applying Cilium LoadBalancer IP pool and L2 announcement policy..."
kubectl apply -f src/apps/infrastructure/cilium-l2/ippool.yaml
echo "âœ“ IP pool configured (192.168.0.200-253)"
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          LoadBalancer Setup Complete! ğŸ‰                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "LoadBalancer services will now receive IPs from 192.168.0.200-253"
echo "IPs are announced via L2 (ARP) on eno* interfaces"
"""

[tasks.bootstrap-gitops]
description = "Install ArgoCD and configure GitOps (run after setup-loadbalancer)"
run = """
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘              Bootstrapping GitOps with ArgoCD                  â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "==> [1/4] Creating argocd namespace..."
kubectl apply -f src/bootstrap/argocd/namespace.yaml
echo "âœ“ Namespace created"
echo ""

echo "==> [2/4] Installing ArgoCD via Helm..."
helm upgrade --install argocd argo/argo-cd --version 7.7.12 \
  --namespace argocd \
  --values src/bootstrap/argocd/values.yaml
echo "âœ“ ArgoCD installed"
echo ""

echo "==> [3/4] Waiting for ArgoCD to be ready..."
kubectl wait --for=condition=ready pod -l app.kubernetes.io/name=argocd-server -n argocd --timeout=180s
echo "âœ“ ArgoCD is ready"
echo ""

echo "==> [4/4] Creating root Application (points ArgoCD at src/apps/)..."
echo "âš ï¸  NOTE: You need to update src/bootstrap/argocd/root-app.yaml with your GitHub repo URL first!"
echo ""
read -p "Have you updated the GitHub repo URL in root-app.yaml? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
  echo "Please update src/bootstrap/argocd/root-app.yaml and run this task again"
  exit 1
fi
kubectl apply -f src/bootstrap/argocd/root-app.yaml
echo "âœ“ Root application created"
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘          GitOps Bootstrap Complete! ğŸ‰                         â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ArgoCD is now managing all resources in src/apps/"
echo ""
echo "Get ArgoCD admin password:"
echo "  kubectl -n argocd get secret argocd-initial-admin-secret -o jsonpath='{.data.password}' | base64 -d && echo"
echo ""
echo "Access ArgoCD UI:"
echo "  kubectl get svc -n argocd argocd-server"
echo "  (Use the LoadBalancer IP)"
"""

# ============================================================================
# PHASE 4: Cluster Initialization (New Cluster)
# ============================================================================
# These tasks bootstrap a new cluster from freshly wiped nodes.

[tasks.init-cluster]
description = "Initialize new cluster (apply + bootstrap + kubeconfig + setup)"
alias = "init"
run = """
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘           Initializing Talos Cluster: norns                   â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "==> [1/6] Applying configs to all nodes..."
talosctl apply-config --insecure --nodes ${URD_IP} --file controlplane-urd.yaml
talosctl apply-config --insecure --nodes ${VERDANDI_IP} --file controlplane-verdandi.yaml
talosctl apply-config --insecure --nodes ${SKULD_IP} --file controlplane-skuld.yaml
echo "âœ“ Configs applied"
echo ""

echo "==> [2/6] Configuring talosconfig endpoints..."
talosctl config endpoint ${URD_IP} ${VERDANDI_IP} ${SKULD_IP} --talosconfig ./talosconfig
echo "âœ“ Endpoints configured"
echo ""

echo "==> [3/6] Bootstrapping etcd on urd..."
talosctl bootstrap --nodes ${URD_IP} --talosconfig ./talosconfig
echo "âœ“ Bootstrap initiated"
echo ""

echo "==> [4/6] Waiting for cluster to be ready (30s)..."
sleep 30
echo "âœ“ Wait complete"
echo ""

echo "==> [5/6] Generating kubeconfig..."
talosctl --nodes ${URD_IP} --talosconfig ./talosconfig kubeconfig . --force
echo "âœ“ kubeconfig generated"
echo ""

echo "==> [6/6] Installing configs to home directory..."
mkdir -p ~/.talos
cp ./talosconfig ~/.talos/config
echo "  âœ“ talosconfig â†’ ~/.talos/config"

mkdir -p ~/.kube
cp ./kubeconfig ~/.kube/config
echo "  âœ“ kubeconfig â†’ ~/.kube/config"
echo ""

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                  Cluster Initialized! ğŸ‰                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "Next steps:"
echo "  - Run 'mise run health' to verify cluster health"
echo "  - Run 'kubectl get nodes' to see your nodes"
"""

# ============================================================================
# PHASE 5: Node Configuration Management (Existing Cluster)
# ============================================================================
# These tasks apply configuration updates to running nodes.

[tasks.apply-all]
description = "Apply configs to all nodes (existing cluster)"
alias = "apply"
run = """
echo "==> Applying configs to all nodes..."
talosctl apply-config --nodes ${URD_IP} --file controlplane-urd.yaml
echo "  âœ“ urd (${URD_IP})"

talosctl apply-config --nodes ${VERDANDI_IP} --file controlplane-verdandi.yaml
echo "  âœ“ verdandi (${VERDANDI_IP})"

talosctl apply-config --nodes ${SKULD_IP} --file controlplane-skuld.yaml
echo "  âœ“ skuld (${SKULD_IP})"

echo ""
echo "âœ“ All nodes updated"
"""

[tasks.apply-urd]
description = "Apply config to urd only"
run = "talosctl apply-config --nodes ${URD_IP} --file controlplane-urd.yaml"

[tasks.apply-verdandi]
description = "Apply config to verdandi only"
run = "talosctl apply-config --nodes ${VERDANDI_IP} --file controlplane-verdandi.yaml"

[tasks.apply-skuld]
description = "Apply config to skuld only"
run = "talosctl apply-config --nodes ${SKULD_IP} --file controlplane-skuld.yaml"

# ============================================================================
# PHASE 6: Cluster Operations & Maintenance
# ============================================================================
# These tasks perform operational tasks on a running cluster.

[tasks.health-check]
description = "Check cluster health (Talos + Kubernetes)"
alias = "health"
run = """
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘                    Cluster Health Check                       â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "=== Talos Health ==="
talosctl --nodes ${URD_IP} health \
  --control-plane-nodes ${URD_IP},${VERDANDI_IP},${SKULD_IP}

echo ""
echo "=== Kubernetes Nodes ==="
kubectl get nodes -o wide

echo ""
echo "=== System Pods ==="
kubectl get pods -A
"""

[tasks.upgrade]
description = "Upgrade all nodes to new Talos version (requires TALOS_IMAGE env var)"
run = """
if [ -z "$TALOS_IMAGE" ]; then
  echo "âŒ TALOS_IMAGE environment variable not set"
  echo ""
  echo "Usage:"
  echo "  TALOS_IMAGE=factory.talos.dev/installer-secureboot/<schematic>:v1.11.5 mise run upgrade"
  echo ""
  echo "Get the installer image from 'mise run generate-schematic'"
  exit 1
fi

echo "==> Upgrading all nodes to: $TALOS_IMAGE"
echo ""

echo "==> Upgrading urd (${URD_IP})..."
talosctl upgrade --nodes ${URD_IP} --image "$TALOS_IMAGE" --preserve
echo "âœ“ urd upgraded"
echo ""

echo "==> Upgrading verdandi (${VERDANDI_IP})..."
talosctl upgrade --nodes ${VERDANDI_IP} --image "$TALOS_IMAGE" --preserve
echo "âœ“ verdandi upgraded"
echo ""

echo "==> Upgrading skuld (${SKULD_IP})..."
talosctl upgrade --nodes ${SKULD_IP} --image "$TALOS_IMAGE" --preserve
echo "âœ“ skuld upgraded"
echo ""

echo "âœ“ All nodes upgraded to $TALOS_IMAGE"
"""

# ============================================================================
# PHASE 7: Disaster Recovery
# ============================================================================
# These tasks help with cluster recovery and troubleshooting.

[tasks.reset-node]
description = "Reset a specific node (requires NODE env var)"
run = """
if [ -z "$NODE" ]; then
  echo "âŒ NODE environment variable not set"
  echo ""
  echo "Usage:"
  echo "  NODE=192.168.0.120 mise run reset-node"
  exit 1
fi

echo "âš ï¸  WARNING: This will wipe all data on node $NODE"
read -p "Are you sure? (yes/no): " confirm
if [ "$confirm" != "yes" ]; then
  echo "Aborted"
  exit 0
fi

talosctl reset --nodes $NODE --graceful=false
echo "âœ“ Node $NODE has been reset"
"""
