apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: loki-stack
  namespace: argocd
spec:
  project: default
  source:
    chart: loki-stack
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 2.10.2
    helm:
      valuesObject:
        # ====================================================================
        # Loki Configuration (Log Storage Backend)
        # ====================================================================
        loki:
          enabled: true

          # Persistence using Longhorn
          persistence:
            enabled: true
            storageClassName: longhorn
            size: 20Gi

          # Loki configuration
          config:
            auth_enabled: false

            # Storage configuration for single-binary mode
            schema_config:
              configs:
                - from: 2024-01-01
                  store: tsdb
                  object_store: filesystem
                  schema: v13
                  index:
                    prefix: index_
                    period: 24h

            # Retention - keep logs for 7 days (matches Prometheus)
            limits_config:
              retention_period: 168h
              max_query_length: 721h
              max_query_series: 10000

            # Compactor - cleanup old logs
            compactor:
              working_directory: /data/compactor
              retention_enabled: true
              retention_delete_delay: 2h
              retention_delete_worker_count: 150

          # Resource limits for homelab
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi

          # Service configuration
          service:
            type: ClusterIP
            port: 3100

          # ServiceMonitor for Prometheus
          serviceMonitor:
            enabled: true
            interval: 30s

        # ====================================================================
        # Promtail Configuration (Log Collection Agent)
        # ====================================================================
        promtail:
          enabled: true

          # Run on all nodes
          tolerations:
            - effect: NoSchedule
              operator: Exists

          # Resource limits
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
            limits:
              cpu: 200m
              memory: 256Mi

          # Promtail configuration
          config:
            # Send logs to Loki
            clients:
              - url: http://loki-stack:3100/loki/api/v1/push

            # Scrape configs
            scrape_configs:
              # ==============================================================
              # Kubernetes Pod Logs (Automatic for ALL pods)
              # ==============================================================
              - job_name: kubernetes-pods
                pipeline_stages:
                  - cri: {}
                kubernetes_sd_configs:
                  - role: pod
                relabel_configs:
                  # Add namespace label
                  - source_labels:
                      - __meta_kubernetes_namespace
                    target_label: namespace

                  # Add pod name label
                  - source_labels:
                      - __meta_kubernetes_pod_name
                    target_label: pod

                  # Add container name label
                  - source_labels:
                      - __meta_kubernetes_pod_container_name
                    target_label: container

                  # Add node name label
                  - source_labels:
                      - __meta_kubernetes_pod_node_name
                    target_label: node

                  # Add app label
                  - source_labels:
                      - __meta_kubernetes_pod_label_app_kubernetes_io_name
                    target_label: app

                  # Use pod UID and container name as path
                  - source_labels:
                      - __meta_kubernetes_pod_uid
                      - __meta_kubernetes_pod_container_name
                    target_label: __path__
                    separator: /
                    replacement: /var/log/pods/*$1/*.log

              # ==============================================================
              # NOTE: Talos system logs (kernel, services) require separate
              # collection via talosctl CLI or Talos logging endpoint.
              # This will be added in the Talos metrics collection task.
              # Container logs above provide 90% of needed observability.
              # ==============================================================

          # ServiceMonitor for Prometheus
          serviceMonitor:
            enabled: true
            interval: 30s

        # ====================================================================
        # Grafana Integration
        # ====================================================================
        grafana:
          # Don't deploy Grafana (we already have it from kube-prometheus-stack)
          enabled: false

          # Loki datasource will be added via sidecar
          sidecar:
            datasources:
              enabled: true
              label: grafana_datasource
              labelValue: "1"

  destination:
    server: https://kubernetes.default.svc
    namespace: loki-stack

  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
      - ServerSideApply=true
    managedNamespaceMetadata:
      labels:
        pod-security.kubernetes.io/enforce: privileged
        pod-security.kubernetes.io/audit: privileged
        pod-security.kubernetes.io/warn: privileged
    retry:
      limit: 5
      backoff:
        duration: 5s
        factor: 2
        maxDuration: 3m
