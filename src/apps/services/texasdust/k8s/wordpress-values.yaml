# WordPress Helm Chart Values (groundhog2k/wordpress)
# Deploys WordPress for texasdust.org nonprofit site
# Note: replicaCount set to 1 due to ReadWriteOnce storage limitation

replicaCount: 1

# Deployment strategy (Recreate prevents multi-attach errors with RWO storage)
strategy:
  type: Recreate

image:
  registry: "docker.io"
  repository: "wordpress"
  pullPolicy: IfNotPresent
  tag: "6.8-php8.4-apache"

# Pod security context (run as www-data, non-root)
podSecurityContext:
  fsGroup: 33
  runAsUser: 33
  runAsNonRoot: true

# Container security context
# Note: readOnlyRootFilesystem disabled for Apache (needs /var/run/apache2, /tmp)
securityContext:
  readOnlyRootFilesystem: false
  allowPrivilegeEscalation: false
  privileged: false
  capabilities:
    drop:
      - ALL

# Service configuration
service:
  type: ClusterIP
  port: 80
  annotations: {}

# Resource limits and requests
resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 500m
    memory: 512Mi

# Horizontal Pod Autoscaler (disabled due to RWO storage limitation)
autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 1
  targetCPUUtilizationPercentage: 70
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15

# Health probes (increased timeouts for WordPress)
startupProbe:
  enabled: true
  initialDelaySeconds: 10
  timeoutSeconds: 5
  failureThreshold: 30
  successThreshold: 1
  periodSeconds: 10

livenessProbe:
  enabled: false
  initialDelaySeconds: 60
  timeoutSeconds: 15
  failureThreshold: 5
  successThreshold: 1
  periodSeconds: 20

readinessProbe:
  enabled: false
  initialDelaySeconds: 30
  timeoutSeconds: 10
  failureThreshold: 5
  successThreshold: 1
  periodSeconds: 10

# External database configuration (MariaDB)
# Note: Password below is a placeholder - actual password injected via env from 1Password
externalDatabase:
  name: wordpress
  user: wordpress
  password: "placeholder"  # Overridden by WORDPRESS_DB_PASSWORD env var from secret
  host: mariadb

# WordPress settings
settings:
  tablePrefix: "wp_"
  maxFileUploadSize: 64M
  memoryLimit: 256M
  configExtra: |
    // Redis Object Cache configuration
    define('WP_REDIS_CLIENT', 'phpredis');
    define('WP_REDIS_HOST', 'valkey');
    define('WP_REDIS_PORT', '6379');
    define('WP_REDIS_DATABASE', '0');
    define('WP_REDIS_PREFIX', 'wp_');

    // Security hardening
    define('DISALLOW_FILE_EDIT', true);
    define('FORCE_SSL_ADMIN', true);

# Custom PHP configuration
customPhpConfig: |
  ; PHP-FPM Performance Tuning
  pm = dynamic
  pm.max_children = 50
  pm.start_servers = 10
  pm.min_spare_servers = 5
  pm.max_spare_servers = 15
  pm.max_requests = 500

  ; PHP settings
  upload_max_filesize = 64M
  post_max_size = 64M
  max_execution_time = 300
  max_input_time = 300
  memory_limit = 256M

# Environment variables from 1Password secrets
extraEnvSecrets:
  - wordpress-db-credentials

# Additional environment variables
env:
  - name: WORDPRESS_DB_HOST
    value: mariadb
  - name: WORDPRESS_DB_NAME
    value: wordpress
  - name: WORDPRESS_DB_USER
    value: wordpress
  - name: WORDPRESS_DB_PASSWORD
    valueFrom:
      secretKeyRef:
        name: wordpress-db-credentials
        key: password
  - name: WORDPRESS_CONFIG_EXTRA
    value: |
      define('WP_HOME', 'https://texasdust.org');
      define('WP_SITEURL', 'https://texasdust.org');

# Storage configuration (Longhorn PVC for uploads)
storage:
  requestedSize: 50Gi
  className: longhorn
  accessModes:
    - ReadWriteOnce
  keepPvc: true
  annotations: {}

# Network policy (will be defined separately for better control)
networkPolicy: {}

# Pod labels for monitoring
podLabels:
  app: wordpress
  component: web

# Pod annotations for Prometheus monitoring
podAnnotations:
  prometheus.io/scrape: "true"
  prometheus.io/port: "9253"
  prometheus.io/path: "/metrics"
