# Cilium v1.18.3 Configuration for Talos Linux Homelab
# Documentation: https://docs.cilium.io/

# ============================================================================
# API Server Access (required for Talos)
# ============================================================================
k8sServiceHost: 192.168.0.120
k8sServicePort: 6443

# ============================================================================
# IPAM Configuration
# ============================================================================
ipam:
  mode: kubernetes

# ============================================================================
# Kube-Proxy Replacement
# ============================================================================
# Note: Will fully take effect after disabling kube-proxy in Talos config
kubeProxyReplacement: true

# ============================================================================
# Gateway API Support
# ============================================================================
gatewayAPI:
  enabled: true

# ============================================================================
# Prometheus Metrics
# ============================================================================
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true

operator:
  prometheus:
    enabled: true
    serviceMonitor:
      enabled: true

# ============================================================================
# Hubble Observability
# ============================================================================
hubble:
  enabled: true

  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - port-distribution
      - icmp
      - httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction
    serviceMonitor:
      enabled: true

  relay:
    enabled: true
    rollOutPods: true
    prometheus:
      enabled: true
      serviceMonitor:
        enabled: true

  ui:
    enabled: true
    rollOutPods: true
    ingress:
      enabled: false  # Can expose via Gateway API instead

# ============================================================================
# Security
# ============================================================================
securityContext:
  capabilities:
    ciliumAgent:
      - CHOWN
      - KILL
      - NET_ADMIN
      - NET_RAW
      - IPC_LOCK
      - SYS_ADMIN
      - SYS_RESOURCE
      - DAC_OVERRIDE
      - FOWNER
      - SETGID
      - SETUID
    cleanCiliumState:
      - NET_ADMIN
      - SYS_ADMIN
      - SYS_RESOURCE

# ============================================================================
# L2 Announcements (LoadBalancer IP advertisement via ARP)
# ============================================================================
l2announcements:
  enabled: true

# Increase API rate limits for L2 announcements
k8sClientRateLimit:
  qps: 10
  burst: 20

# ============================================================================
# Talos-Specific Settings
# ============================================================================
cgroup:
  autoMount:
    enabled: false
  hostRoot: /sys/fs/cgroup
